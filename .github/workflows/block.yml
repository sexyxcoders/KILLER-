name: ùöª’∞“Ω ùö®≈ÅÍ™Æ‚≤õùõÜ üö©ùóßŒµ·ßò‚Äå·¥ç

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write

jobs:
  full-check:
    runs-on: ubuntu-latest

    steps:
      # Checkout repo
      - uses: actions/checkout@v6

      # Setup Python
      - uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      # Install uv
      - name: Install uv
        run: curl -LsSf https://astral.sh/uv/install.sh | sh

      # Add uv to PATH
      - name: Add uv to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # Sync deps (strict, reproducible)
      - name: Sync from uv.lock
        run: uv sync --frozen

      # Install formatting & audit tools
      - name: Install tools
        run: uv pip install black isort ruff pip-audit

      # Black + isort formatting
      - name: Format python files
        run: |
          uv run black .
          uv run isort .

      # Ruff auto-fix (never fail CI)
      - name: Ruff auto-fix
        run: |
          uv run ruff check . \
            --fix \
            --unsafe-fixes \
            --exit-zero

      # Check if anything changed (code / uv.lock)
      - name: Detect changes
        run: |
          uv lock --check || true
          if [ -n "$(git status --porcelain)" ]; then
            echo "CHANGED=true" >> $GITHUB_ENV
          else
            echo "CHANGED=false" >> $GITHUB_ENV
          fi

      # Security audit (won‚Äôt fail build)
      - name: Dependency audit
        continue-on-error: true
        run: uv run pip-audit

      # Create PR only if changes exist
      - name: Create Pull Request
        if: env.CHANGED == 'true' && github.actor != 'github-actions[bot]'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "Auto update: full repo auto-fix"
          title: "‚úÖ Automated repo auto-fix"
          body: |
            ‚úî Black formatting  
            ‚úî Import sorting (isort)  
            ‚úî Ruff auto-fix (safe + unsafe)  
            ‚úî uv.lock consistency check  

            ‚ö° This PR is fully automated.
            ‚ùå CI will never fail due to lint issues.
          labels: auto-fix, uv, ci
          branch: repo-auto-check-${{ github.run_id }}
          delete-branch: true
